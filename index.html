
import React, { useMemo, useState, useCallback, useRef, useEffect } from 'react';
import { Session, SessionStatus, Payment } from '../types';
import { useApp } from '../contexts/AppContext';
import AddPaymentModal from './AddPaymentModal';
import ConfirmationModal from './ConfirmationModal';
import EditSessionModal from './EditSessionModal';

interface SessionCardProps {
    session: Session;
}

const formatDate = (dateString: string | null) => {
    if (!dateString) return 'Fecha pendiente';
    // Use T00:00:00 to treat the date as local, avoiding timezone shifts.
    return new Date(dateString + 'T00:00:00').toLocaleDateString('es-AR', {
        day: '2-digit',
        month: 'long',
        year: 'numeric'
    });
};

const formatPaymentDate = (dateString: string) => {
    return new Date(dateString + 'T00:00:00').toLocaleDateString('es-AR', {
        day: '2-digit', month: '2-digit', year: 'numeric'
    });
}

const getSessionState = (session: Session) => {
    const now = new Date();

    if (session.status === SessionStatus.CANCELLED) {
        return { text: 'Cancelada', color: 'text-red-400 bg-red-900/50', borderColor: 'border-red-500/50' };
    }
    
    if (session.date) {
        const sessionDateTime = new Date(`${session.date}T${session.time || '23:59:59'}`);
        if (sessionDateTime < now) {
            return { text: 'Finalizada', color: 'text-zinc-400 bg-zinc-700/50', borderColor: 'border-zinc-700' };
        }
    } else {
         return { text: 'Fecha Pendiente', color: 'text-blue-400 bg-blue-900/50 font-semibold', borderColor: 'border-blue-500/50' };
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const sessionDay = new Date(session.date + 'T00:00:00');
    const diffTime = sessionDay.getTime() - today.getTime();
    const daysRemaining = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (daysRemaining === 0) {
        return { text: 'Hoy', color: 'text-green-400 bg-green-900/50 font-semibold', borderColor: 'border-green-500/50' };
    }
    if (daysRemaining === 1) {
        return { text: 'Mañana', color: 'text-yellow-400 bg-yellow-900/50 font-semibold', borderColor: 'border-yellow-500/50' };
    }
    if (daysRemaining <= 7) {
        return { text: `En ${daysRemaining} días`, color: 'text-yellow-400 bg-yellow-900/50', borderColor: 'border-yellow-500/50' };
    }
    return { text: `Faltan ${daysRemaining} días`, color: 'text-zinc-400 bg-zinc-800/50', borderColor: 'border-zinc-700' };
};

const HistoryIcon: React.FC<{ tooltip: string }> = ({ tooltip }) => (
    <span title={tooltip} className="cursor-help">
        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clipRule="evenodd" />
        </svg>
    </span>
);

const SessionCard: React.FC<SessionCardProps> = ({ session }) => {
    const { cancelSession, restoreSession, updateSession, addNotification, deleteSession } = useApp();

    const [isAddPaymentModalOpen, setAddPaymentModalOpen] = useState(false);
    const [isEditModalOpen, setEditModalOpen] = useState(false);
    const [isCancelModalOpen, setCancelModalOpen] = useState(false);
    const [isRestoreModalOpen, setRestoreModalOpen] = useState(false);
    const [isDeleteModalOpen, setDeleteModalOpen] = useState(false);
    const [isEditingNotes, setIsEditingNotes] = useState(false);
    const [localNotes, setLocalNotes] = useState(session.notes);
    const [isPaymentsVisible, setIsPaymentsVisible] = useState(false);
    
    const notesTextareaRef = useRef<HTMLTextAreaElement>(null);

    const sessionState = useMemo(() => getSessionState(session), [session]);
    const isFinished = sessionState.text === 'Finalizada';
    const totalPaid = useMemo(() => session.payments.reduce((sum, p) => sum + Number(p.amount), 0), [session.payments]);
    const remaining = useMemo(() => session.price - totalPaid, [session.price, totalPaid]);
    const progress = useMemo(() => (session.price > 0 ? (totalPaid / session.price) * 100 : (totalPaid > 0 ? 100 : 0)), [totalPaid, session.price]);

    const handleCancel = useCallback(async () => {
        await cancelSession(session.id);
        addNotification('Sesión cancelada.', 'success');
        setCancelModalOpen(false);
    }, [session.id, cancelSession, addNotification]);

    const handleRestore = useCallback(async () => {
        await restoreSession(session.id);
        addNotification('Sesión restaurada.', 'success');
        setRestoreModalOpen(false);
    }, [session.id, restoreSession, addNotification]);
    
    const handleDelete = useCallback(async () => {
        await deleteSession(session.id);
        setDeleteModalOpen(false);
    }, [session.id, deleteSession]);

    const handleNotesSave = useCallback(async () => {
        // Only save if notes have actually changed
        if (localNotes !== session.notes) {
            try {
                await updateSession(session.id, { notes: localNotes });
                addNotification('Anotaciones guardadas.', 'success');
            } catch {
                addNotification('Error al guardar anotaciones.', 'error');
                setLocalNotes(session.notes); // Revert on error
            }
        }
        setIsEditingNotes(false);
    }, [localNotes, session.notes, session.id, updateSession, addNotification]);

    useEffect(() => {
        if (isEditingNotes) {
            notesTextareaRef.current?.focus();
            notesTextareaRef.current?.select();
        }
    }, [isEditingNotes]);
    
    const handlePrint = useCallback(() => {
        const paymentStatus = remaining <= 0 ? 'Pagado' : 'Pendiente';
        const formattedFullDate = session.date ? new Date(session.date + 'T00:00:00').toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'Fecha pendiente';

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = session.notes;
        const sanitizedNotes = tempDiv.textContent || tempDiv.innerText || "";

        const printContent = `
          <html>
            <head>
              <title>Keii Portillo - Fotografía</title>
              <style>
                @import url('https://rsms.me/inter/inter.css');
                @page {
                  size: A4;
                  margin: 20mm;
                }
                body { 
                  font-family: 'Inter', sans-serif; 
                  background-color: white; 
                  color: #1f2937; 
                  -webkit-print-color-adjust: exact; 
                  print-color-adjust: exact;
                  font-size: 10pt;
                }
                .print-container { 
                  display: flex;
                  flex-direction: column;
                  height: 100%;
                }
                main {
                    flex-grow: 1;
                }
                .header { text-align: center; margin-bottom: 1.5rem; }
                .header img { 
                    height: 50px; 
                    margin-bottom: 0.75rem; 
                    filter: invert(1);
                }
                .header p { margin: 1px 0; font-size: 0.9em; color: #4b5563; }
                .footer { 
                    text-align: center;
                    padding-top: 1rem; 
                    margin-top: auto;
                    font-size: 0.8em; 
                    color: #6b7280;
                    border-top: 1px solid #d1d5db;
                }
                .content-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 1rem;
                }
                .section {
                    border: 1px solid #9ca3af;
                    border-radius: 8px;
                    padding: 1rem;
                    break-inside: avoid;
                    overflow: hidden;
                }
                .section-title { 
                  font-size: 1.1em; 
                  font-weight: 600; 
                  color: #111827;
                  background-color: #f3f4f6;
                  padding: 0.75rem;
                  margin: -1rem -1rem 1rem -1rem;
                  border-bottom: 1px solid #9ca3af;
                }
                .details-list p {
                    margin: 0.35rem 0;
                    font-size: 1em;
                }
                .details-list strong {
                    font-weight: 600;
                    color: #374151;
                    margin-right: 0.5rem;
                }
                .full-width {
                    grid-column: span 2;
                }
                .notes { 
                  background-color: #f9fafb; 
                  border: 1px solid #f0f0f0; 
                  padding: 0.75rem; 
                  border-radius: 6px; 
                  white-space: pre-wrap; 
                  font-size: 0.95em;
                  word-wrap: break-word;
                  margin-top: 0.5rem;
                }
                table { width: 100%; border-collapse: collapse; font-size: 0.95em; }
                th, td { text-align: left; padding: 0.5rem; border-bottom: 1px solid #d1d5db; }
                th { background-color: #f9fafb; font-weight: 600; color: #374151;}
                .summary-table-container { display: flex; justify-content: flex-start; margin-top: 1rem; }
                .summary-table { width: 50%; border: none; }
                .summary-table td { text-align: right; padding: 0.25rem 0; border: none; }
                .summary-table td:first-child { text-align: left; font-weight: 600; }
              </style>
            </head>
            <body>
              <div class="print-container">
                <div class="header">
                    <img src="https://dn721904.ca.archive.org/0/items/logo-01_202507/logo-01.svg" alt="Logo Keii Portillo">
                    <p>Kaii Portillo Fotografía</p>
                    <p>2477238364</p>
                    <p>@keiiportillo_fotografía</p>
                    <p>Pergamino - Bs As</p>
                </div>

                <main>
                    <div class="content-grid">
                        <div class="section">
                            <h2 class="section-title">Detalle del Cliente y Servicio</h2>
                            <div class="details-list">
                                <p><strong>Cliente:</strong>${session.client_name}</p>
                                <p><strong>Contacto:</strong>${session.contact}</p>
                                <p><strong>Servicio:</strong>${session.service_type}</p>
                                <p><strong>Costo:</strong>$${session.price.toLocaleString('es-AR')}</p>
                            </div>
                        </div>

                        <div class="section">
                            <h2 class="section-title">Detalle de la Sesión</h2>
                            <div class="details-list">
                                <p><strong>Fecha:</strong>${formattedFullDate}</p>
                                <p><strong>Hora:</strong>${session.time ? session.time + ' hs' : 'Horario pendiente'}</p>
                                <p><strong>Lugar:</strong>${session.location}</p>
                            </div>
                        </div>

                        <div class="section full-width">
                            <h2 class="section-title">Pagos</h2>
                            <table>
                              <thead><tr><th>Fecha</th><th>Monto</th><th>Método</th></tr></thead>
                              <tbody>
                                ${session.payments.length > 0 ? session.payments.map((p: Payment) => `
                                  <tr>
                                    <td>${formatPaymentDate(p.date)}</td>
                                    <td>$${Number(p.amount).toLocaleString('es-AR')}</td>
                                    <td>${p.method}</td>
                                  </tr>
                                `).join('') : `<tr><td colspan="3" style="text-align:center; padding: 1rem; color: #6b7280;">No hay pagos registrados.</td></tr>`}
                              </tbody>
                            </table>
                            <div class="summary-table-container">
                                <table class="summary-table">
                                  <tbody>
                                    <tr><td>Total pagado:</td><td>$${totalPaid.toLocaleString('es-AR')}</td></tr>
                                    <tr><td>Restante:</td><td>$${remaining.toLocaleString('es-AR')}</td></tr>
                                    <tr><td><strong>Estado:</strong></td><td><strong>${paymentStatus}</strong></td></tr>
                                  </tbody>
                                </table>
                            </div>
                        </div>

                        ${session.notes ? `
                        <div class="section full-width">
                            <h2 class="section-title">Anotaciones</h2>
                            <div class="notes">${sanitizedNotes}</div>
                        </div>
                        ` : ''}
                    </div>
                </main>

                <div class="footer">
                    <p>2025 - Keii Portillo Fotografía - Documento no válido como factura</p>
                </div>
              </div>
            </body>
          </html>
        `;
        
        const printWindow = window.open('', '_blank');
        if (printWindow) {
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.onload = () => {
                printWindow.print();
            };
        } else {
            addNotification('Por favor, habilita las ventanas emergentes para imprimir.', 'error');
        }
    }, [session, totalPaid, remaining, addNotification]);

    return (
        <>
            <div className={`flex flex-col bg-zinc-800 rounded-xl shadow-lg border ${sessionState.borderColor} transition-all duration-300`}>
                <div className="p-4 border-b border-zinc-700">
                    <div className="flex justify-between items-start gap-3">
                        <h3 className="font-bold text-white text-lg flex-1 truncate" title={session.client_name}>
                           {session.client_name}
                        </h3>
                         <span className={`px-2 py-1 text-xs font-bold rounded-full ${sessionState.color}`}>
                            {sessionState.text}
                        </span>
                    </div>
                    <p className="text-sm text-zinc-400">{session.service_type}</p>
                </div>

                <div className="p-4 space-y-4 flex-grow">
                     {/* Financial Status */}
                    <div>
                        <div className="flex justify-between items-center mb-1 text-sm">
                            <span className="text-zinc-300">Pagado</span>
                            <span className="font-semibold text-white">${totalPaid.toLocaleString('es-AR')} / ${session.price.toLocaleString('es-AR')}</span>
                        </div>
                        <div className="w-full bg-zinc-700 rounded-full h-2.5">
                            <div className="bg-green-500 h-2.5 rounded-full" style={{ width: `${progress}%` }}></div>
                        </div>
                        {remaining > 0 && <p className="text-right text-xs text-yellow-400 mt-1">Restan ${remaining.toLocaleString('es-AR')}</p>}
                    </div>

                    {session.payments.length > 0 && (
                        <div>
                            <button
                                onClick={() => setIsPaymentsVisible(prev => !prev)}
                                className="w-full flex justify-between items-center text-left text-sm font-medium text-zinc-300 hover:text-white py-1"
                                aria-expanded={isPaymentsVisible}
                            >
                                <span>Ver historial de pagos ({session.payments.length})</span>
                                <svg xmlns="http://www.w3.org/2000/svg" className={`h-5 w-5 transform transition-transform duration-200 ${isPaymentsVisible ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div className={`transition-all duration-300 ease-in-out overflow-hidden ${isPaymentsVisible ? 'max-h-96' : 'max-h-0'}`}>
                                <div className="border-t border-zinc-700/50 mt-1 pt-2 pr-2 space-y-2">
                                    {session.payments.map((p) => (
                                        <div key={p.id} className="flex justify-between items-center text-xs">
                                            <span className="text-zinc-400">{formatPaymentDate(p.date)}</span>
                                            <span className="text-zinc-300">{p.method}</span>
                                            <span className="font-semibold text-white">${Number(p.amount).toLocaleString('es-AR')}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Session Details */}
                    <div className="text-sm space-y-2">
                        <div className="flex items-center gap-2">
                            <svg className="w-4 h-4 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            <span className="text-zinc-300">{formatDate(session.date)}</span>
                            {session.is_rescheduled && <HistoryIcon tooltip="Reprogramado" />}
                        </div>
                         <div className="flex items-center gap-2">
                            <svg className="w-4 h-4 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                             <span className="text-zinc-300">{session.time || 'Horario pendiente'}</span>
                             {session.is_time_changed && <HistoryIcon tooltip="Horario cambiado" />}
                        </div>
                        <div className="flex items-start gap-2">
                             <svg className="w-4 h-4 text-zinc-400 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                            <span className="text-zinc-300">{session.location}</span>
                            {session.is_relocated && <HistoryIcon tooltip="Relocalizado" />}
                        </div>
                    </div>

                    <div className="pt-2">
                        <label htmlFor={`notes-${session.id}`} className="text-xs text-zinc-400 mb-1 font-semibold">Anotaciones:</label>
                        {isEditingNotes ? (
                            <textarea
                                id={`notes-${session.id}`}
                                ref={notesTextareaRef}
                                value={localNotes}
                                onChange={(e) => setLocalNotes(e.target.value)}
                                onBlur={handleNotesSave}
                                className="w-full text-sm text-zinc-200 bg-zinc-700 p-2 rounded-md border border-white/30 focus:ring-1 focus:ring-white focus:outline-none transition"
                                rows={4}
                            />
                        ) : (
                            <div
                                onClick={() => setIsEditingNotes(true)}
                                className="w-full text-sm text-zinc-300 bg-zinc-900/50 p-2 rounded-md whitespace-pre-wrap min-h-[40px] cursor-pointer hover:bg-zinc-700 transition-colors"
                            >
                                {session.notes ? (
                                    session.notes
                                ) : (
                                    <span className="text-zinc-500 italic">Agregar anotaciones...</span>
                                )}
                            </div>
                        )}
                    </div>
                </div>

                <div className="px-4 py-3 bg-zinc-900/50 rounded-b-xl border-t border-zinc-700 flex items-center justify-end space-x-2">
                    {session.status === SessionStatus.ACTIVE && remaining > 0 && (
                        <button onClick={() => setAddPaymentModalOpen(true)} className="text-xs font-semibold text-white bg-green-600 hover:bg-green-700 px-3 py-1.5 rounded-md transition-colors" title="Añadir Pago">
                            Añadir Pago
                        </button>
                    )}
                    
                    <button onClick={() => setEditModalOpen(true)} className="p-2 text-zinc-400 hover:text-white hover:bg-zinc-700 rounded-full transition-colors" title="Editar Sesión">
                       <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" /></svg>
                    </button>
                    <button onClick={handlePrint} className="p-2 text-zinc-400 hover:text-white hover:bg-zinc-700 rounded-full transition-colors" title="Imprimir Resumen">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h1v-4a1 1 0 011-1h8a1 1 0 011 1v4h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clipRule="evenodd" /></svg>
                    </button>
                    
                    {session.status === SessionStatus.ACTIVE && !isFinished && (
                        <button onClick={() => setCancelModalOpen(true)} className="p-2 text-zinc-400 hover:text-red-500 hover:bg-red-900/50 rounded-full transition-colors" title="Cancelar Sesión">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" /></svg>
                        </button>
                    )}
                    
                    {session.status === SessionStatus.CANCELLED && (
                        <>
                            <button onClick={() => setRestoreModalOpen(true)} className="p-2 text-zinc-400 hover:text-green-500 hover:bg-green-900/50 rounded-full transition-colors" title="Restaurar Sesión">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-10.707a1 1 0 00-1.414-1.414L9 9.586 7.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>
                            </button>
                             <button onClick={() => setDeleteModalOpen(true)} className="p-2 text-zinc-400 hover:text-red-500 hover:bg-red-900/50 rounded-full transition-colors" title="Eliminar Permanentemente">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" />
                                </svg>
                            </button>
                        </>
                    )}
                </div>
            </div>

            {isAddPaymentModalOpen && (
                <AddPaymentModal session={session} onClose={() => setAddPaymentModalOpen(false)} />
            )}

            {isEditModalOpen && (
                <EditSessionModal session={session} onClose={() => setEditModalOpen(false)} />
            )}

            {isCancelModalOpen && (
                <ConfirmationModal
                    isOpen={isCancelModalOpen}
                    onClose={() => setCancelModalOpen(false)}
                    onConfirm={handleCancel}
                    title="Cancelar Sesión"
                    message="¿Estás seguro de que quieres cancelar esta sesión? Esta acción la moverá a la sección de 'Canceladas'."
                    confirmText="Sí, Cancelar"
                    confirmButtonColor="bg-red-600 hover:bg-red-700 focus:ring-red-500"
                />
            )}

            {isRestoreModalOpen && (
                <ConfirmationModal
                    isOpen={isRestoreModalOpen}
                    onClose={() => setRestoreModalOpen(false)}
                    onConfirm={handleRestore}
                    title="Restaurar Sesión"
                    message="¿Estás seguro de que quieres restaurar esta sesión? Volverá a estar activa."
                    confirmText="Sí, Restaurar"
                    confirmButtonColor="bg-green-600 hover:bg-green-700 focus:ring-green-500"
                />
            )}

            {isDeleteModalOpen && (
                <ConfirmationModal
                    isOpen={isDeleteModalOpen}
                    onClose={() => setDeleteModalOpen(false)}
                    onConfirm={handleDelete}
                    title="Eliminar Sesión Permanentemente"
                    message={<>¿Estás seguro de que quieres eliminar esta sesión? Esta acción es <strong>irreversible</strong> y también se eliminarán todos los pagos asociados.</>}
                    confirmText="Sí, Eliminar Permanentemente"
                    confirmButtonColor="bg-red-600 hover:bg-red-700 focus:ring-red-500"
                />
            )}
        </>
    );
};

export default SessionCard;
